<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

</head>
<body>
    <h1>待辦事項</h1>
    待辦事項：<input type="text" id="item">
    期限：<input type="date" id="date">
    <button id="add">新增</button>
    <table border="1" cellspacing="0" cellpadding="5" style="margin-top: 20px;">
        <tr>
            <th>完成否</th>
            <th>待辦事項</th>
            <th>期限</th>
            <th>操作</th>
        </tr>
        <tbody id="list">
            <!-- 待辦事項會顯示在這裡 -->
        </tbody>
    </table>

    <script>
        $(function() {
            var todos = [];

            // 從 localStorage 讀取已儲存的待辦事項
            var savedTodos = localStorage.getItem('todos');
            if (savedTodos) {
                todos = JSON.parse(savedTodos);
                // 重新顯示已儲存的待辦事項
                todos.forEach(function(todo) {
                    var newRow = '<tr>' +
                        '<td align="center">' +
                        // 透過三元運算子決定 checkbox 是否被勾選, 判斷式?true的值:false的值
                        '<input type="checkbox" id="todo_' + todo.id + '" ' + (todo.done ? 'checked' : '') + '>' +
                        '</td>' +
                        '<td>' + todo.item + '</td>' +
                        '<td>' + todo.date + '</td>' +
                        '<td><button class="del" data-id="' + todo.id + '">刪除</button></td>'
                        '</tr>';
                    $('#list').append(newRow);
                });
            }

            $('#add').click(function() {
                var item = $('#item').val();
                var date = $('#date').val();

                var todo = {
                    id: Date.now(),
                    done: false,
                    item: item,
                    date: date
                }

                todos.push(todo);

                // 根據日期對待辦事項進行排序，將日期較早的事項顯示在前面
                todos.sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });

                if (item && date) {
                    // 清空表格內容，重新顯示排序後的待辦事項
                    $('#list').empty();
                    // 重新顯示已儲存的待辦事項
                    todos.forEach(function(todo) {
                        var newRow = '<tr>' +
                            '<td align="center">' +
                            // 透過三元運算子決定 checkbox 是否被勾選, 判斷式?true的值:false的值
                            '<input type="checkbox" id="todo_' + todo.id + '" ' + (todo.done ? 'checked' : '') + '>' +
                            '</td>' +
                            '<td>' + todo.item + '</td>' +
                            '<td>' + todo.date + '</td>' +
                            '<td><button class="del" data-id="' + todo.id + '">刪除</button></td>'
                            '</tr>';
                        $('#list').append(newRow);
                    });

                    saveTodos();
                } else {
                    alert('請輸入待辦事項和期限');
                }
            });

            function saveTodos() {
                var dataToSave = JSON.stringify(todos);
                localStorage.setItem('todos', dataToSave);
                // alert('待辦事項已儲存');
            }

            // 監聽 checkbox 的變化，更新待辦事項的完成狀態
            $('#list').on('change', 'input[type="checkbox"]', function() {
                // 透過 split 取得 checkbox 的 id，從中提取待辦事項的 id，
                // 如：todo_1770385335021，則提取出 [0]todo, [1]1770385335021
                var id = $(this).attr('id').split('_')[1];
                var todo = todos.find(function(t) { return t.id == id; });
                if (todo) {
                    // 更新待辦事項的完成狀態
                    todo.done = $(this).is(':checked');
                    saveTodos();
                }
            });

            // 監聽刪除按鈕的點擊事件，刪除對應的待辦事項
            $('#list').on('click', '.del', function() {
                // 彈出確認對話框，詢問使用者是否確定要刪除
                if(confirm('確定要刪除嗎？') == false){
                    return;
                }
                var id = $(this).data('id');
                // 從 todos 陣列中移除對應的待辦事項
                // filter 方法會返回一個新的陣列，包含所有不符合條件的元素，即 id 不等於要刪除的 id 的元素
                todos = todos.filter(function(t) { return t.id != id; });
                // 從 DOM 中移除對應的表格行
                $(this).closest('tr').remove();
                saveTodos();
            });
        })
    </script>
    
</body>
</html>